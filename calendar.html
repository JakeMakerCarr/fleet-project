<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fleet Calendar (YFNED Fleet + NFC One-Sticker Method)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />

  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.9.0/main.min.css" rel="stylesheet">

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- jQuery Timepicker CSS & JS -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.js"></script>

  <link rel="stylesheet" href="style.css">

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }
    header {
      background: #333;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
    }
    #user-info {
      margin-right: 1rem;
    }
    #logout-btn {
      cursor: pointer;
      padding: 0.5rem 1rem;
      background: #666;
      color: white;
      border-radius: 4px;
      border: none;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: white;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .calendar-and-details {
      display: flex;
      gap: 1rem;
    }
    .calendar-section {
      flex: 1;
    }
    .details-section {
      flex: 0 0 300px;
      border-left: 1px solid #ccc;
      padding-left: 1rem;
    }
    #booking-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 1rem;
      max-width: 600px;
    }
    .form-row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    #booking-form label {
      display: flex;
      flex-direction: column;
      font-weight: bold;
      flex: 1;
      min-width: 200px;
    }
    #booking-form input,
    #booking-form select {
      padding: 0.5rem;
      font-size: 1rem;
      box-sizing: border-box;
      width: 100%;
    }
    .action-button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      background-color: #333;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      max-width: 200px;
      margin-top: 1rem;
    }
    .action-button:hover {
      background-color: #555;
    }
  </style>
</head>

<body>
<header>
  <div>Fleet Calendar</div>
  <div id="user-info">Checking auth...</div>
  <button id="logout-btn" style="display:none;">Logout</button>
</header>

<div class="container">
  <h2>YFNED Fleet Calendar</h2>

  <form id="booking-form">
    <div class="form-row">
      <label>
        Select a Vehicle:
        <select id="vehicle-select" required>
          <!-- your options… -->
          <option value="01-20 2021 Red Traverse CM335">2021 Red Traverse CM335</option>
          <!-- … -->
          <option value="18-25 2024 White Ford F750 CVVVVV">2024 White Ford F750 CVVVVV</option>
        </select>
      </label>
    </div>

    <div class="form-row">
      <label>
        Start Date (Mon-Fri):
        <input type="date" id="booking-start-date" required>
      </label>
      <label>
        End Date (optional, Mon-Fri):
        <input type="date" id="booking-end-date">
      </label>
    </div>

    <div class="form-row">
      <label>
        Start Time:
        <input type="text" id="booking-start-time" required>
      </label>
      <label>
        End Time:
        <input type="text" id="booking-end-time" required>
      </label>
    </div>

    <button id="bookVehicleBtn" class="action-button">Book Vehicle</button>
  </form>

  <div class="calendar-and-details">
    <div class="calendar-section">
      <h1 id="vehicle-schedule-heading"></h1>
      <div id="calendar"></div>
    </div>
    <div class="details-section">
      <div id="selected-date-info">
        <h3>Selected Date: <span id="selected-date-text"></span></h3>
        <div id="date-bookings-list">No bookings.</div>
      </div>
    </div>
  </div>
</div>

<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.9.0/main.min.js"></script>

<!-- Firebase Scripts -->
<script type="module">
  import { initializeApp }    from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
  import { getAuth, onAuthStateChanged, signOut }
                             from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';
  import { getDatabase, ref, get, push, set, update }
                             from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js';

  const firebaseConfig = {
    apiKey: "AIzaSyAjnCWLnUf8msIUjL0TBdZ1eCAiXMLOwvU",
    authDomain: "yfned-fleet-nfc.firebaseapp.com",
    databaseURL: "https://yfned-fleet-nfc-default-rtdb.firebaseio.com",
    projectId: "yfned-fleet-nfc",
    storageBucket: "yfned-fleet-nfc.appspot.com",
    messagingSenderId: "482363667898",
    appId: "1:482363667898:web:4b0364e891a221e9631983",
    measurementId: "G-LK66DQVKW4"
  };

  const app       = initializeApp(firebaseConfig);
  const auth      = getAuth(app);
  const db        = getDatabase(app);
  let currentUser = null;
  let calendar    = null;

  // DOM refs
  const userInfo               = document.getElementById('user-info');
  const logoutBtn              = document.getElementById('logout-btn');
  const vehicleSelect          = document.getElementById('vehicle-select');
  const vehicleHeading         = document.getElementById('vehicle-schedule-heading');
  const bookingStartDateInput  = document.getElementById('booking-start-date');
  const bookingEndDateInput    = document.getElementById('booking-end-date');
  const bookingStartTimeInput  = document.getElementById('booking-start-time');
  const bookingEndTimeInput    = document.getElementById('booking-end-time');
  const bookVehicleBtn         = document.getElementById('bookVehicleBtn');
  const selectedDateTextEl     = document.getElementById('selected-date-text');
  const dateBookingsListEl     = document.getElementById('date-bookings-list');
  let lastClickedDayEl         = null;

  onAuthStateChanged(auth, user => {
    if (!user) {
      window.location.href = 'index.html';
      return;
    }
    currentUser = user;
    userInfo.textContent = 'Logged in as: ' + user.email;
    logoutBtn.style.display = 'inline-block';

    // timepicker
    $('#booking-start-time, #booking-end-time').timepicker({
      timeFormat: 'h:mm p',
      interval: 30,
      minTime: '6:00am',
      maxTime: '9:00pm',
      dynamic: false,
      dropdown: true,
      scrollbar: true
    });

    initCalendar();
    updateVehicleHeading(vehicleSelect.value);

    vehicleSelect.addEventListener('change', async () => {
      await updateVehicleHeading(vehicleSelect.value);
      calendar.refetchEvents();
    });

    bookVehicleBtn.addEventListener('click', async e => {
      e.preventDefault();
      await handleMultiDayBooking();
    });

    logoutBtn.addEventListener('click', async () => {
      await signOut(auth);
    });
  });

  async function updateVehicleHeading(vehicleName) {
    const snap = await get(ref(db, 'vehicles/' + vehicleName));
    if (snap.exists()) {
      const d = snap.val();
      if (d.status === 'signedOut') {
        vehicleHeading.textContent = `${vehicleName} schedule: Currently Signed Out by: ${d.CurrentlySignedOutBy}`;
      } else {
        vehicleHeading.textContent = `${vehicleName} schedule: Available`;
      }
    } else {
      vehicleHeading.textContent = `${vehicleName} schedule: Available`;
    }
  }

  function initCalendar() {
    const calendarEl = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      timeZone: 'local',
      events: fetchVehicleBookings,
      displayEventTime: false,
      dateClick: info => {
        if (lastClickedDayEl) lastClickedDayEl.style.backgroundColor = '';
        info.dayEl.style.backgroundColor = 'lightblue';
        lastClickedDayEl = info.dayEl;
        selectedDateTextEl.textContent = info.dateStr;
        displayBookingsForDay(getEventsForDate(info.date), info.dateStr);
        bookingStartDateInput.value = info.dateStr;
      }
    });
    calendar.render();
  }

  async function fetchVehicleBookings(fetchInfo, success, failure) {
    const vehicle = vehicleSelect.value;
    if (!vehicle) return success([]);
    const snap = await get(ref(db, 'bookings/' + vehicle));
    if (!snap.exists()) return success([]);
    const data = snap.val();
    const events = Object.entries(data).map(([id, b]) => ({
      id,
      title: `${b.startTime}-${b.endTime}`,
      start: new Date(b.startTimeISO),
      end:   new Date(b.endTimeISO),
      extendedProps: { creatorEmail: b.userName }
    }));
    success(events);
  }

  function getEventsForDate(date) {
    const dayStart = new Date(date).setHours(0,0,0,0);
    const dayEnd   = new Date(dayStart).setDate(new Date(dayStart).getDate()+1);
    return calendar.getEvents().filter(ev =>
      ev.start < dayEnd && ev.end > dayStart
    );
  }

  function displayBookingsForDay(events, dateStr) {
    if (events.length === 0) {
      dateBookingsListEl.textContent = 'No bookings on ' + dateStr + '.';
      return;
    }
    dateBookingsListEl.innerHTML = events.map(ev => `
      <div>
        <strong>${ev.extendedProps.creatorEmail}</strong><br>
        Start: ${ev.start.toLocaleString()}<br>
        End:   ${ev.end.toLocaleString()}
      </div>
    `).join('');
  }

  async function isBookingOverlapping(vehicleName, newStart, newEnd) {
    const snap = await get(ref(db, 'bookings/' + vehicleName));
    if (!snap.exists()) return false;
    return Object.values(snap.val()).some(b => {
      const s = new Date(b.startTimeISO).getTime();
      const e = new Date(b.endTimeISO).getTime();
      return newStart < e && newEnd > s;
    });
  }

  function toTimestamp(dateStr, timeStr) {
    const [year, month, day] = dateStr.split('-').map(Number);
    let [time, modifier] = timeStr.split(' ');
    let [hours, minutes] = time.split(':').map(Number);
    if (modifier === 'PM' && hours !== 12) hours += 12;
    if (modifier === 'AM' && hours === 12) hours = 0;
    return new Date(year, month-1, day, hours, minutes).getTime();
  }

  // *** FIXED: use valueAsDate to get a LOCAL midnight Date ***
  async function handleMultiDayBooking() {
    const vehicle = vehicleSelect.value;
    if (!vehicle) { alert('No vehicle selected.'); return; }

    // grab true Date objects at local midnight
    const startDate = bookingStartDateInput.valueAsDate;
    const endDate   = bookingEndDateInput.valueAsDate || bookingStartDateInput.valueAsDate;

    if (!startDate || !bookingStartTimeInput.value || !bookingEndTimeInput.value) {
      alert('Please provide dates and times.'); return;
    }
    if (startDate > endDate) {
      alert('Start date cannot be after end date.');
      return;
    }

    const bookingsToCreate = [];
    let currentDate = new Date(startDate);

    while (currentDate <= endDate) {
      const dow = currentDate.getDay(); // 1 = Mon … 5 = Fri
      if (dow >= 1 && dow <= 5) {
        // build YYYY-MM-DD string
        const y = currentDate.getFullYear();
        const m = String(currentDate.getMonth()+1).padStart(2,'0');
        const d = String(currentDate.getDate()).padStart(2,'0');
        const dateStr = `${y}-${m}-${d}`;

        const startTS = toTimestamp(dateStr, bookingStartTimeInput.value);
        const endTS   = toTimestamp(dateStr, bookingEndTimeInput.value);
        if (endTS <= startTS) {
          alert(`End time must be after start time on ${dateStr}!`);
          return;
        }
        if (await isBookingOverlapping(vehicle, startTS, endTS)) {
          alert(`Conflict detected on ${dateStr}. Booking aborted.`);
          return;
        }

        bookingsToCreate.push({
          userName:       currentUser.email,
          date:           dateStr,
          startTime:      bookingStartTimeInput.value,
          endTime:        bookingEndTimeInput.value,
          startTimeISO:   new Date(startTS).toISOString(),
          endTimeISO:     new Date(endTS).toISOString()
        });
      }
      currentDate.setDate(currentDate.getDate() + 1);
    }

    if (bookingsToCreate.length === 0) {
      alert('No valid weekdays selected.');
      return;
    }

    for (const b of bookingsToCreate) {
      const refBooking = push(ref(db, 'bookings/' + vehicle));
      await set(refBooking, b);
    }
    alert('All bookings created successfully!');
    calendar.refetchEvents();
  }
</script>
</body>
</html>
