<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fleet Calendar (YFNED Fleet + NFC One-Sticker Method)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.9.0/main.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.js"></script>
  <link rel="stylesheet" href="style.css">
  <style>
    body { margin: 0; padding: 0; font-family: sans-serif; }
    header {
      background: #333; color: white; display: flex; justify-content: space-between;
      align-items: center; padding: 1rem;
    }
    #user-info { margin-right: 1rem; }
    #logout-btn {
      cursor: pointer; padding: 0.5rem 1rem; border: none;
      background: #666; color: white; border-radius: 4px;
    }
    .container {
      max-width: 1200px; margin: 1rem auto; background: white; padding: 1rem;
      border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 { margin-top: 0; }
    .vehicle-select-container { margin-bottom: 1rem; }
    select, input[type="date"], input[type="time"] {
      font-size: 1rem; padding: 0.3rem; margin: 0.3rem 0;
    }
    #booking-form {
      display: flex; flex-wrap: wrap; gap: 1rem;
      margin-bottom: 1rem; align-items: center;
    }
    #booking-form label {
      display: flex; flex-direction: column;
      font-weight: bold;
    }
    #signOutBtn, #returnVehicleBtn {
      margin-bottom: 1rem; margin-right: 1rem;
    }
    .calendar-and-details { display: block; }
    @media (min-width: 800px) {
      .calendar-and-details { display: flex; gap: 1rem; }
    }
    .calendar-section { flex: 1; min-width: 0; }
    #vehicle-schedule-heading {
      width: 100%; text-align: center; font-size: 2rem;
      font-weight: bold; color: #333; margin: 0 0 1rem 0;
    }
    #calendar { margin-top: 2rem; }
    .details-section {
      flex: 0 0 300px; border-left: 1px solid #ccc;
      padding-left: 1rem; margin-top: 1rem;
    }
    @media (min-width: 800px) {
      .details-section { margin-top: 0; }
    }
    #selected-date-info {
      background: #fafafa; border-radius: 6px; padding: 1rem;
    }
    #selected-date-info h3 { font-size: 1.25rem; margin: 0 0 0.5rem; }
    #date-bookings-list { font-size: 1rem; line-height: 1.4; }
    #date-bookings-list div { margin-bottom: 0.75rem; }
    #booking-start, #booking-end {
      font-size: 1.1rem; padding: 0.5rem; width: 260px;
    }
    .ui-timepicker-wrapper {
      width: 140px !important; font-size: 1rem;
      z-index: 9999 !important;
    }
    .ui-timepicker-list li {
      white-space: nowrap; padding: 6px 10px;
    }
    small { font-weight: normal; font-size: 0.8rem; color: #666; }
  </style>
</head>
<body>

<header>
  <div>Fleet Calendar</div>
  <div id="user-info">Checking auth...</div>
  <button id="logout-btn" style="display:none;">Logout</button>
</header>

<div class="container">
  <h2>YFNED Fleet Calendar</h2>
  
  <!-- VEHICLE SELECT DROPDOWN -->
  <div class="vehicle-select-container">
    <label for="vehicle-select">Select a Vehicle:</label>
    <select id="vehicle-select">
      <option value="01-20 2021 Red Traverse CM335">2021 Red Traverse CM335</option>
      <option value="02-20 2021 Black Traverse CM366">2021 Black Traverse CM366</option>
      <option value="03-21 2021 Grey Traverse CN360">2021 Grey Traverse CN360</option>
      <option value="04-21 2021 Shadow Silverado 1500 CM695">2021 Shadow Silverado 1500 CM695</option>
      <option value="05-21 2021 Ebony Buick Encore CM532">2021 Ebony Buick Encore CM532</option>
      <option value="06-21 2020 Grey Grand Caravan CN468">2020 Grey Grand Caravan CN468</option>
      <option value="07-21 2021 White Terrain CN466">2021 White Terrain CN466</option>
      <option value="08-21 2021 Black Terrain CN467">2021 Black Terrain CN467</option>
      <option value="09-24 2024 White Sierra 3500 C182B">2024 White Sierra 3500 C182B</option>
      <option value="10-24 2025 Green Trailblazer C838B">2025 Green Trailblazer C838B</option>
      <option value="11-24 2024 Grey Traverse CS266">2024 Grey Traverse CS266</option>
      <option value="12-24 2012 White Dodge HNL64">2012 White Dodge HNL64</option>
      <option value="13-24 2024 Grey Traverse CT008">2024 Grey Traverse CT008</option>
      <option value="14-24 2024 Grey Traverse C443C">2024 Grey Traverse C443C</option>
      <option value="15-24 2024 Grey Traverse C444C">2024 Grey Traverse C444C</option>
      <option value="16-24 2024 Blue Traverse CT073">2024 Blue Traverse CT073</option>
      <option value="17-25 2025 Black Buick Envision CV294">2025 Black Buick Envision CV294</option>
      <option value="18-25 2024 White Ford F750 CVVVVV">2024 White Ford F750 CVVVVV</option>
    </select>
  </div>

  <div id="booking-section">
    <h3>Book This Vehicle</h3>
    <form id="booking-form">
      <label>
        Start Date (Mon–Fri only):
        <input type="date" id="booking-start-date" />
      </label>
      <label>
        End Date (Mon–Fri only):
        <input type="date" id="booking-end-date" placeholder="Optional" />
        <small>Leave blank to book only one day</small>
      </label>
      <label>
        Start Time (6AM - 9PM):
        <input type="text" id="booking-start" placeholder="Select Start Time" />
      </label>
      <label>
        End Time (6AM - 9PM):
        <input type="text" id="booking-end" placeholder="Select End Time" />
      </label>
      <button type="submit" id="bookVehicleBtn" class="action-button">Book Vehicle</button>
    </form>
    <button id="signOutBtn" class="action-button">Sign Out Selected Vehicle Now</button>
    <button id="returnVehicleBtn" class="action-button">Return Vehicle Now</button>
  </div>

  <div class="calendar-and-details">
    <div class="calendar-section">
      <h1 id="vehicle-schedule-heading"></h1>
      <div id="calendar"></div>
    </div>
    <div class="details-section">
      <div id="selected-date-info">
        <h3>Selected Date: <span id="selected-date-text"></span></h3>
        <div id="date-bookings-list">No date selected yet.</div>
      </div>
    </div>
  </div>
</div>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.9.0/main.min.js"></script>

<script>
  // Firebase config
  const firebaseConfig = {
  apiKey: "AIzaSyAjnCWLnUf8msIUjL0TBdZ1eCAiXMLOwvU",
  authDomain: "yfned-fleet-nfc.firebaseapp.com",
  databaseURL: "https://yfned-fleet-nfc-default-rtdb.firebaseio.com",
  projectId: "yfned-fleet-nfc",
  storageBucket: "yfned-fleet-nfc.firebasestorage.app",
  messagingSenderId: "482363667898",
  appId: "1:482363667898:web:4b0364e891a221e9631983",
  measurementId: "G-LK66DQVKW4"
};

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  let currentUser = null;
  let calendar = null;

  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      document.getElementById("user-info").innerText = user.email;
      document.getElementById("logout-btn").style.display = "inline-block";
      initCalendar();
    } else {
      window.location.href = "index.html";
    }
  });

  document.getElementById("logout-btn").onclick = () => auth.signOut();

  const getVehicle = () => document.getElementById("vehicle-select").value;

  function initCalendar() {
    const calendarEl = document.getElementById("calendar");
    calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      selectable: true,
      dateClick: info => displayDateDetails(info.dateStr),
      events: fetchEvents
    });
    calendar.render();
    displayDateDetails(new Date().toISOString().split("T")[0]);
  }

  function fetchEvents(fetchInfo, successCallback, failureCallback) {
    const vehicle = getVehicle();
    db.ref(`bookings/${vehicle}`).once("value", snapshot => {
      const events = [];
      snapshot.forEach(daySnap => {
        const date = daySnap.key;
        daySnap.forEach(bookingSnap => {
          const data = bookingSnap.val();
          events.push({
            title: `${data.startTime} - ${data.endTime}`,
            start: `${date}`,
            allDay: true
          });
        });
      });
      successCallback(events);
    });
  }

  function displayDateDetails(dateStr) {
    document.getElementById("selected-date-text").innerText = dateStr;
    const list = document.getElementById("date-bookings-list");
    list.innerHTML = "Loading...";
    const vehicle = getVehicle();
    db.ref(`bookings/${vehicle}/${dateStr}`).once("value", snapshot => {
      if (!snapshot.exists()) {
        list.innerText = "No bookings on " + dateStr + ".";
        return;
      }
      let html = "";
      snapshot.forEach(snap => {
        const data = snap.val();
        html += `<div>
            ${data.user} <br>
            Start: ${data.startTime}<br>
            End: ${data.endTime}
            <br><button onclick="removeBooking('${vehicle}', '${dateStr}', '${snap.key}')">Remove</button>
          </div>`;
      });
      list.innerHTML = html;
    });
  }

  function removeBooking(vehicle, date, key) {
    db.ref(`bookings/${vehicle}/${date}/${key}`).remove().then(() => {
      calendar.refetchEvents();
      displayDateDetails(date);
    });
  }

  function getWeekdayDatesInRange(start, end) {
    const dates = [];
    const curr = new Date(start);
    const final = new Date(end);
    while (curr <= final) {
      const day = curr.getDay(); // 0 = Sunday, 6 = Saturday
      if (day >= 1 && day <= 5) {
        dates.push(new Date(curr).toISOString().split("T")[0]);
      }
      curr.setDate(curr.getDate() + 1);
    }
    return dates;
  }

  document.getElementById("booking-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const vehicle = getVehicle();
    const startDateInput = document.getElementById("booking-start-date").value;
    const endDateInput = document.getElementById("booking-end-date").value;
    const startTime = document.getElementById("booking-start").value;
    const endTime = document.getElementById("booking-end").value;

    if (!startDateInput || !startTime || !endTime) {
      alert("Please fill in all required fields.");
      return;
    }

    const endDate = endDateInput ? new Date(endDateInput) : new Date(startDateInput);
    const bookingDates = getWeekdayDatesInRange(new Date(startDateInput), endDate);

    for (let date of bookingDates) {
      const ref = db.ref(`bookings/${vehicle}/${date}`);
      const snapshot = await ref.once("value");
      let conflict = false;
      snapshot.forEach(snap => {
        const existing = snap.val();
        if (
          (startTime < existing.endTime && endTime > existing.startTime)
        ) {
          conflict = true;
        }
      });
      if (conflict) {
        alert(`Conflict detected on ${date}. Booking cancelled.`);
        return;
      }
    }

    for (let date of bookingDates) {
      await db.ref(`bookings/${vehicle}/${date}`).push({
        user: currentUser.email,
        startTime,
        endTime,
        timestamp: new Date().toISOString()
      });
    }

    calendar.refetchEvents();
    alert("Booking successful.");
  });

  $("#booking-start").timepicker({
    timeFormat: "h:i A",
    interval: 30,
    minTime: "6:00am",
    maxTime: "9:00pm",
    startTime: "6:00",
    dynamic: false,
    dropdown: true,
    scrollbar: true
  });

  $("#booking-end").timepicker({
    timeFormat: "h:i A",
    interval: 30,
    minTime: "6:00am",
    maxTime: "9:00pm",
    startTime: "6:00",
    dynamic: false,
    dropdown: true,
    scrollbar: true
  });

  document.getElementById("vehicle-select").addEventListener("change", () => {
    calendar.refetchEvents();
    const vehicle = getVehicle();
    document.getElementById("vehicle-schedule-heading").innerText = vehicle + " schedule: Available";
  });

  document.getElementById("signOutBtn").addEventListener("click", () => {
    const vehicle = getVehicle();
    const today = new Date().toISOString().split("T")[0];
    db.ref(`vehicleStatus/${vehicle}`).set({
      status: "out",
      user: currentUser.email,
      time: new Date().toISOString()
    });
    alert("Vehicle signed out.");
  });

  document.getElementById("returnVehicleBtn").addEventListener("click", () => {
    const vehicle = getVehicle();
    db.ref(`vehicleStatus/${vehicle}`).set({
      status: "in",
      user: currentUser.email,
      time: new Date().toISOString()
    });
    alert("Vehicle returned.");
  });
</script>
</body>
</html>
