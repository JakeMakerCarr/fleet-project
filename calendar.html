<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>YFNED Fleet Calendar</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />

  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.9.0/main.min.css" rel="stylesheet" />
  
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- jQuery Timepicker CSS & JS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.js"></script>

  <!-- Optional External Styles -->
  <link rel="stylesheet" href="style.css">

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }

    header {
      background: #333;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
    }

    #user-info {
      margin-right: 1rem;
    }

    #logout-btn {
      cursor: pointer;
      padding: 0.5rem 1rem;
      border: none;
      background: #666;
      color: white;
      border-radius: 4px;
    }

    .container {
      max-width: 1200px;
      margin: 1rem auto;
      background: white;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    h2 {
      margin-top: 0;
    }

    .vehicle-select-container {
      margin-bottom: 1rem;
    }

    select,
    input[type="date"],
    input[type="time"] {
      font-size: 1rem;
      padding: 0.3rem;
      margin: 0.3rem 0;
    }

    #booking-form {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
      align-items: center;
    }

    #booking-form label {
      display: flex;
      flex-direction: column;
      font-weight: bold;
    }

    .calendar-and-details {
      display: block;
    }

    @media (min-width: 800px) {
      .calendar-and-details {
        display: flex;
        gap: 1rem;
      }
    }

    .calendar-section {
      flex: 1;
    }

    #vehicle-schedule-heading {
      width: 100%;
      text-align: center;
      font-size: 2rem;
      font-weight: bold;
      color: #333;
      margin-bottom: 1rem;
    }

    #calendar {
      margin-top: 2rem;
    }

    .details-section {
      flex: 0 0 300px;
      border-left: 1px solid #ccc;
      padding-left: 1rem;
    }

    #selected-date-info {
      background: #fafafa;
      border-radius: 6px;
      padding: 1rem;
    }

    #selected-date-info h3 {
      font-size: 1.25rem;
      margin: 0 0 0.5rem;
    }

    #date-bookings-list {
      font-size: 1rem;
      line-height: 1.4;
    }

    #date-bookings-list div {
      margin-bottom: 0.75rem;
    }

    #booking-start,
    #booking-end {
      font-size: 1.1rem;
      padding: 0.5rem;
      width: 260px;
    }

    .ui-timepicker-wrapper {
      width: 140px !important;
      font-size: 1rem;
      z-index: 9999 !important;
    }

    .ui-timepicker-list li {
      white-space: nowrap;
      padding: 6px 10px;
    }
  </style>
</head>
<body>
  <header>
    <div>Fleet Calendar</div>
    <div id="user-info">Checking auth...</div>
    <button id="logout-btn" style="display:none;">Logout</button>
  </header>

  <div class="container">
    <h2>YFNED Fleet Calendar</h2>

    <!-- VEHICLE SELECT DROPDOWN -->
    <div class="vehicle-select-container">
      <label for="vehicle-select">Select a Vehicle:</label>
      <select id="vehicle-select">
        <option value="01-20 2021 Red Traverse CM335">2021 Red Traverse CM335</option>
        <option value="02-20 2021 Black Traverse CM366">2021 Black Traverse CM366</option>
        <option value="03-21 2021 Grey Traverse CN360">2021 Grey Traverse CN360</option>
        <option value="04-21 2021 Shadow Silverado 1500 CM695">2021 Shadow Silverado 1500 CM695</option>
        <option value="05-21 2021 Ebony Buick Encore CM532">2021 Ebony Buick Encore CM532</option>
        <option value="06-21 2020 Grey Grand Caravan CN468">2020 Grey Grand Caravan CN468</option>
        <option value="07-21 2021 White Terrain CN466">2021 White Terrain CN466</option>
        <option value="08-21 2021 Black Terrain CN467">2021 Black Terrain CN467</option>
        <option value="09-24 2024 White Sierra 3500 C182B">2024 White Sierra 3500 C182B</option>
        <option value="10-24 2025 Green Trailblazer C838B">2025 Green Trailblazer C838B</option>
        <option value="11-24 2024 Grey Traverse CS266">2024 Grey Traverse CS266</option>
        <option value="12-24 2012 White Dodge HNL64">2012 White Dodge HNL64</option>
        <option value="13-24 2024 Grey Traverse CT008">2024 Grey Traverse CT008</option>
        <option value="14-24 2024 Grey Traverse C443C">2024 Grey Traverse C443C</option>
        <option value="15-24 2024 Grey Traverse C444C">2024 Grey Traverse C444C</option>
        <option value="16-24 2024 Blue Traverse CT073">2024 Blue Traverse CT073</option>
        <option value="17-25 2025 Black Buick Envision CV294">2025 Black Buick Envision CV294</option>
        <option value="18-25 2024 White Ford F750 CVVVVV">2024 White Ford F750 CVVVVV</option>
      </select>
    </div>

    <!-- BOOKING FORM -->
    <div id="booking-section">
      <h3>Book This Vehicle</h3>
      <form id="booking-form">
        <label>
          Date (Mon-Fri only):
          <input type="date" id="booking-date" />
        </label>
        <label>
          Start Time (6AM - 9PM):
          <input type="text" id="booking-start" placeholder="Select Start Time" />
        </label>
        <label>
          End Time (6AM - 9PM):
          <input type="text" id="booking-end" placeholder="Select End Time" />
        </label>
        <button type="submit" id="bookVehicleBtn" class="action-button">Book Vehicle</button>
      </form>
    </div>

    <!-- CALENDAR + DETAILS WRAPPER -->
    <div class="calendar-and-details">
      <!-- LEFT: CALENDAR -->
      <div class="calendar-section">
        <h1 id="vehicle-schedule-heading"></h1>
        <div id="calendar"></div>
      </div>

      <!-- RIGHT: SELECTED DATE INFO SIDEBAR -->
      <div class="details-section">
        <div id="selected-date-info">
          <h3>Selected Date: <span id="selected-date-text"></span></h3>
          <div id="date-bookings-list">No date selected yet.</div>
        </div>
      </div>
    </div>
  </div>
<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.9.0/main.min.js"></script>

<!-- Firebase & Booking Logic -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
  import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';
  import { getDatabase, ref, get, push, set, remove } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js';

  const firebaseConfig = {
    apiKey: "AIzaSyAjnCWLnUf8msIUjL0TBdZ1eCAiXMLOwvU",
    authDomain: "yfned-fleet-nfc.firebaseapp.com",
    databaseURL: "https://yfned-fleet-nfc-default-rtdb.firebaseio.com",
    projectId: "yfned-fleet-nfc",
    storageBucket: "yfned-fleet-nfc.appspot.com",
    messagingSenderId: "482363667898",
    appId: "1:482363667898:web:4b0364e891a221e9631983"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  let currentUser = null;
  let calendar = null;

  const vehicleSelect = document.getElementById('vehicle-select');
  const bookingDateInput = document.getElementById('booking-date');
  const bookingStartInput = document.getElementById('booking-start');
  const bookingEndInput = document.getElementById('booking-end');
  const bookBtn = document.getElementById('bookVehicleBtn');
  const selectedDateText = document.getElementById('selected-date-text');
  const dateBookingsList = document.getElementById('date-bookings-list');

  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = 'index.html';
    } else {
      currentUser = user;
      document.getElementById('user-info').textContent = 'Logged in as: ' + user.email;
      document.getElementById('logout-btn').style.display = 'inline-block';

      $('#booking-start, #booking-end').timepicker({
        timeFormat: 'h:mm p',
        interval: 30,
        minTime: '6:00am',
        maxTime: '9:00pm',
        dynamic: false,
        dropdown: true,
        scrollbar: true
      });

      initCalendar();

      vehicleSelect.addEventListener('change', () => {
        updateHeading(vehicleSelect.value);
        calendar.refetchEvents();
      });

      bookBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        await handleBooking();
      });

      updateHeading(vehicleSelect.value);
    }
  });

  document.getElementById('logout-btn').addEventListener('click', async () => {
    await signOut(auth);
  });

  function initCalendar() {
    calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
      initialView: 'dayGridMonth',
      timeZone: 'local',
      displayEventTime: false,
      events: fetchEvents,
      dateClick: (info) => {
        bookingDateInput.value = info.dateStr;
        selectedDateText.textContent = info.dateStr;
        displayEventsForDay(info.date);
      }
    });
    calendar.render();
  }

  function fetchEvents(info, successCallback, failureCallback) {
    const veh = vehicleSelect.value;
    if (!veh) return successCallback([]);

    get(ref(db, `bookings/${veh}`)).then(snapshot => {
      const bookings = snapshot.val() || {};
      const events = [];

      for (const id in bookings) {
        const b = bookings[id];
        events.push({
          id,
          title: `${b.startTime} - ${b.endTime}`,
          start: b.startTimeISO,
          end: b.endTimeISO,
          extendedProps: {
            userName: b.userName
          }
        });
      }

      successCallback(events);
    }).catch(failureCallback);
  }

  function displayEventsForDay(date) {
    const events = calendar.getEvents().filter(ev => {
      const d = new Date(ev.start);
      return d.toDateString() === date.toDateString();
    });

    dateBookingsList.innerHTML = events.length
      ? events.map(ev => `
          <div>
            <strong>${ev.extendedProps.userName}</strong><br>
            ${ev.title}
          </div>
        `).join('')
      : 'No bookings on this day.';
  }

  function toTimestamp(dateStr, timeStr) {
    const [year, month, day] = dateStr.split('-').map(Number);
    const [time, meridian] = timeStr.split(' ');
    let [h, m] = time.split(':').map(Number);
    if (meridian === 'PM' && h !== 12) h += 12;
    if (meridian === 'AM' && h === 12) h = 0;
    return new Date(year, month - 1, day, h, m).getTime();
  }

  async function handleBooking() {
  const veh = vehicleSelect.value;
  const dateStr = bookingDateInput.value;
  const startTime = bookingStartInput.value;
  const endTime = bookingEndInput.value;

  if (!veh || !dateStr || !startTime || !endTime) {
    alert("Please fill in all fields.");
    return;
  }

  const [year, month, day] = dateStr.split('-').map(Number);
  const dateObj = new Date(year, month - 1, day);
  const dayOfWeek = dateObj.getDay();
  if (dayOfWeek === 0 || dayOfWeek === 6) {
    alert('Weekends are not bookable.');
    return;
  }

  const startTS = toTimestamp(dateStr, startTime);
  const endTS = toTimestamp(dateStr, endTime);

  if (endTS <= startTS) {
    alert('End time must be after start time!');
    return;
  }

  const conflict = await isBookingOverlapping(veh, startTS, endTS);
  if (conflict) {
    alert('That time range is already booked for this vehicle!');
    return;
  }

  const bookingRef = push(ref(db, 'bookings/' + veh));
  const startTimeISO = new Date(startTS).toISOString();
  const endTimeISO = new Date(endTS).toISOString();

  await set(bookingRef, {
    userName: currentUser.email,
    date: dateStr,
    startTime,
    endTime,
    startTimeISO,
    endTimeISO
  });

  alert('Booking created!');
  calendar.refetchEvents();
}


  function updateHeading(vehicleName) {
    document.getElementById('vehicle-schedule-heading').textContent = `${vehicleName} Schedule`;
  }
</script>
</body>
</html>
