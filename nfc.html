<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NFC Vehicle Access</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background-color: #5cbde5;
      color: #fff;
      padding: 2rem;
    }

    h1 {
      font-size: 2rem;
    }

    #vehicle-status {
      margin: 1rem 0;
      font-size: 1.2rem;
    }

    button {
      padding: 1rem 2rem;
      font-size: 1.2rem;
      margin: 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    #signOutBtn {
      background-color: #007bff;
      color: white;
    }

    #returnBtn {
      background-color: #28a745;
      color: white;
    }
  </style>
</head>
<body>
  <h1>Checking Vehicle...</h1>
  <div id="vehicle-status"></div>
  <button id="signOutBtn" style="display:none;">Sign Out Vehicle</button>
  <button id="returnBtn" style="display:none;">Return Vehicle</button>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';
    import { getDatabase, ref, get, update, push, set } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAjnCWLnUf8msIUjL0TBdZ1eCAiXMLOwvU",
      authDomain: "yfned-fleet-nfc.firebaseapp.com",
      databaseURL: "https://yfned-fleet-nfc-default-rtdb.firebaseio.com",
      projectId: "yfned-fleet-nfc",
      storageBucket: "yfned-fleet-nfc.firebasestorage.app",
      messagingSenderId: "482363667898",
      appId: "1:482363667898:web:4b0364e891a221e9631983"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const urlParams = new URLSearchParams(window.location.search);
    const vehicleName = urlParams.get('nfcVehicle');

    const statusText = document.getElementById('vehicle-status');
    const signOutBtn = document.getElementById('signOutBtn');
    const returnBtn = document.getElementById('returnBtn');

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }

      if (!vehicleName) {
        statusText.textContent = "No vehicle info found from NFC tag.";
        return;
      }

      const vehicleRef = ref(db, 'vehicles/' + vehicleName);
      const vehicleSnap = await get(vehicleRef);

      if (!vehicleSnap.exists()) {
        statusText.textContent = `${vehicleName} not found in database.`;
        return;
      }

      const vehicleData = vehicleSnap.val();

      if (vehicleData.status === 'signedOut') {
        if (vehicleData.CurrentlySignedOutBy === user.email) {
          statusText.innerHTML = `You currently have the <strong>${vehicleName}</strong> signed out.`;
          returnBtn.style.display = 'inline-block';
        } else {
          statusText.innerHTML = `<strong>${vehicleName}</strong> is currently signed out by someone else.`;
        }
      } else {
        statusText.innerHTML = `<strong>${vehicleName}</strong> is available.`;
        signOutBtn.style.display = 'inline-block';
      }

      signOutBtn.addEventListener('click', async () => {
        await update(vehicleRef, {
          status: 'signedOut',
          CurrentlySignedOutBy: user.email
        });
        await logAction(vehicleName, user.email, 'signedOut');
        alert(`You signed out the ${vehicleName}`);
        location.reload();
      });

      returnBtn.addEventListener('click', async () => {
        await update(vehicleRef, {
          status: 'available',
          CurrentlySignedOutBy: null
        });
        await logAction(vehicleName, user.email, 'signedIn');
        alert(`You returned the ${vehicleName}`);
        location.reload();
      });
    });

    async function logAction(vehicleName, userEmail, action) {
      const logRef = push(ref(db, `vehicleLogs/${vehicleName}`));
      await set(logRef, {
        userEmail,
        action,
        timestamp: Date.now()
      });
    }
  </script>
</body>
</html>
